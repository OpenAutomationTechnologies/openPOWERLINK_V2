#!/bin/bash
#
################################################################################
#  (c) Bernecker + Rainer Industrie-Elektronik Ges.m.b.H.
#      A-5142 Eggelsberg, B&R Strasse 1
#      www.br-automation.com
################################################################################
#
# This script creates the development environment for Altera Nios II Eclipse

source create-this-app.settings

if [ -z "$SOPC_DIR" ]; then
echo "Define path to SOPC file in create-this-app.settings!"
exit 1
fi

if [ -z "$OPT_LEVEL" ]; then
echo "Define optimization level in create-this-app.settings!"
exit 1
fi

if [ -z "$DBG_MODE" ]; then
echo "Define debug mode in create-this-app.settings!"
exit 1
fi

if [ -z "$TC_I_MEM" ]; then
echo "Define tightly-coupled memory in create-this-app.settings!"
exit 1
fi

SOPC_DIR=`readlink -n -f ${SOPC_DIR}`

# export variables needed by create-this-bsp
export SOPC_DIR
export OPT_LEVEL
export DBG_MODE
export QSYS_SUB
export QSYS_SUB_CPU
export TC_I_MEM

# process arguments
SKIP_MAKE=
REBUILD=
SAVE_ARGS=
DUAL_NIOS=
while [ $# -gt 0 ]
do
  case "$1" in
      # Don't run make if create-this-app script is called with --no-make arg
      --no-make)
          SKIP_MAKE=1
          SAVE_ARGS+="$1 "
          ;;
      --rebuild)
          rm -f ./Makefile ${BSP_DIR}/settings.bsp
          REBUILD=1
          SAVE_ARGS+="$1 "
          ;;
      --debug)
          DBG_MODE=_DEBUG
          OPT_LEVEL=-O0
          echo "INFO: Overwritten DBG_MODE to $DBG_MODE"
          echo "INFO: Overwritten OPT_LEVEL to $OPT_LEVEL"
          SAVE_ARGS+="$1 "
          ;;
      --print)
          DBG_MODE=_DEBUG
          echo "INFO: Overwritten DBG_MODE to $DBG_MODE"
          ;;
      --sopcdir)
          shift
          SOPC_DIR=$1
          echo "INFO: Overwritten SOPC_DIR to $SOPC_DIR"
          ;;
      --dual-nios)
          DUAL_NIOS=1
          echo "INFO: Prepare cable setup for single FPGA platform"
          ;;
      --help)
          echo "Usage: ${0} [OPTION]"
          echo
          echo "  --debug        prepares environment for debugging"
          echo "  --print        enables printouts to stdo"
          echo "  --sopcdir PATH path to Quartus project"
          echo "  --dual-nios    prepares cable setup for dual Nios design"
          echo "  --rebuild      recreates the Makefile and the BSP"
          echo "  --no-make      do not run make at the end of this script"
          echo
          echo " Configure the script in the file create-this-app.settings"
          echo " according to your needs before running this script!"
          echo
          exit 1
          ;;
  esac
  shift
done

CFLAGS="-D${DBG_MODE} -DDEF_DEBUG_LVL=${DEF_DEBUG_LVL}"

#workaround for global pointer error
APP_CFLAGS_DEFINED_SYMBOLS="-G4"

NIOS2_APP_GEN_ARGS="--elf-name epl.elf \
--set QSYS_SUB_CPU $QSYS_SUB_CPU \
--set OBJDUMP_INCLUDE_SOURCE 1 \
--set CREATE_OBJDUMP 0 \
--set CFLAGS=${CFLAGS} \
--set APP_INCLUDE_DIRS=${INCLUDES} \
--src-files ${SRCFILES} \
--set APP_CFLAGS_OPTIMIZATION ${OPT_LEVEL}"

# Check if we have NOT a dual nios design.
# In this case the pcp and host fpga cable is determined by create-this-app.settings!
if [ -z "$DUAL_NIOS" ];
then
    NIOS2_APP_GEN_ARGS+=" --set DOWNLOAD_CABLE ${DOWNLOAD_CABLE}"
fi

# First, check to see if $SOPC_KIT_NIOS2 environmental variable is set.
# This variable is required for the command line tools to execute correctly.
if [ -z $SOPC_KIT_NIOS2 ]
then
    echo Required \$SOPC_KIT_NIOS2 Environmental Variable is not set!
    exit 1
fi

# Also make sure that the APP has not been created already.  Check for
# existence of Makefile in the app directory
if [ -f ./Makefile ]
then
    echo Application has already been created!
    echo Delete Makefile if you want to create a new application makefile
    echo or call this script with parameter --rebuild
    exit 1
fi

echo "Creating application for Quartus project ${SOPC_DIR}"
echo

# We are selecting hal_default bsp because it supports this application.
# Check to see if the hal_default has already been generated by checking for
# existence of the public.mk file.  If not, we need to run
# create-this-bsp file to generate the bsp.
if [ -n "$REBUILD" -o ! -f $BSP_DIR/public.mk ]; then
    # Since BSP doesn't exist, create the BSP
    # Pass any command line arguments passed to this script to the BSP.
    pushd $BSP_DIR >> /dev/null
    chmod +x create-this-bsp
    ./create-this-bsp $SAVE_ARGS || {
        echo "create-this-bsp failed"
        exit 1
    }
    popd >> /dev/null

    #workaround for linker.x issue
    chmod +x ${STACKROOT_DIR}/tools/altera_nios2/fix-linkerx
    ${STACKROOT_DIR}/tools/altera_nios2/fix-linkerx
fi

# Set TCI memory size
TCIMEM_SIZE=$(nios2-bsp-query-settings --settings $BSP_DIR/settings.bsp --cmd puts [get_addr_span $TC_I_MEM])

if [ -z "$TCIMEM_SIZE" ]; then
    TCIMEM_SIZE=0
fi

NIOS2_APP_GEN_ARGS="${NIOS2_APP_GEN_ARGS} --set APP_CFLAGS_DEFINED_SYMBOLS=${APP_CFLAGS_DEFINED_SYMBOLS} -DALT_TCIMEM_SIZE=${TCIMEM_SIZE}"

cmd="nios2-app-generate-makefile --bsp-dir $BSP_DIR --set QUARTUS_PROJECT_DIR=$SOPC_DIR $NIOS2_APP_GEN_ARGS"

echo "create-this-app: Running \"$cmd\""
$cmd || {
    echo "nios2-app-generate-makefile failed"
    exit 1
}

cat >> Makefile <<'Heredoc'

# Rules for EPCS flash programming commands (EPCS contains SOF and application)
PROGRAM_EPCS_SUFFIX := -epcs
PROGRAM_EPCS_TARGET := $(addsuffix $(PROGRAM_EPCS_SUFFIX), $(FLASH_FILES))

.PHONY : program-epcs
program-epcs : $(PROGRAM_EPCS_TARGET)

SOF_FILE := $(wildcard $(QUARTUS_PROJECT_DIR)/*.sof)

.PHONY : $(PROGRAM_EPCS_TARGET)
$(PROGRAM_EPCS_TARGET) : $(ELF)
	@$(ECHO) Info: Programming $(basename $@).flash
	@if [ -n "$($(basename $@)_EPCS_FLAGS)" ]; \
	then \
		nios2-configure-sof $(DOWNLOAD_CABLE_FLAG) -C $(QUARTUS_PROJECT_DIR); \
		sof2flash --epcs --input=$(SOF_FILE) --output=sof.flash; \
		$(ELF2FLASH) --after=sof.flash --input=$(ELF) --outfile=$(basename $@)_after_sof.flash --sim_optimize=$(SIM_OPTIMIZE) $(elf2flash_extra_args); \
		$(ECHO) $(FLASHPROG) $(SOPC_SYSID_FLAG) --epcs --base=$($(basename $@)_START) sof.flash $(basename $@)_after_sof.flash; \
		$(FLASHPROG) --cpu_name=$(CPU_NAME) $(DOWNLOAD_CABLE_FLAG) $(SOPC_SYSID_FLAG) --epcs --base=$($(basename $@)_START) -g --override=../generic/nios2-flash-override.txt sof.flash $(basename $@)_after_sof.flash; \
	fi

# Rule for erasing the EPCS memory content
.PHONY : erase-epcs
erase-epcs:
	@nios2-configure-sof $(DOWNLOAD_CABLE_FLAG) -C $(QUARTUS_PROJECT_DIR); \
	$(ECHO) $(FLASHPROG) $(DOWNLOAD_CABLE_FLAG) $(SOPC_SYSID_FLAG) --epcs --base=$($(basename $(PROGRAM_EPCS_TARGET))_START) --accept-bad-sysid --erase-all; \
	$(FLASHPROG) --cpu_name=$(CPU_NAME) $(DOWNLOAD_CABLE_FLAG) $(SOPC_SYSID_FLAG) --epcs --base=$($(basename $(PROGRAM_EPCS_TARGET))_START) --accept-bad-sysid --erase-all

# Rule for downloading the FPGA bitstream to the target
.PHONY : download-bits
download-bits:
	nios2-configure-sof $(DOWNLOAD_CABLE_FLAG) -C $(QUARTUS_PROJECT_DIR)

# Rule for doing magic
.PHONY: download-all
download-all: download-bits download-elf

# Rule to create fpga stuff with one command
.PHONY: rebuild-fpga
rebuild-fpga:
	$(ECHO) "INFO: Change to $(QUARTUS_PROJECT_DIR) and run create-this-fpga."; \
	pushd $(QUARTUS_PROJECT_DIR); \
	./create-this-fpga; \
	popd;

# Rule to regenerate BSP after changes in Qsys
.PHONY: rebuild-bsp
rebuild-bsp:
	$(ECHO) "INFO: Regenerate BSP."; \
	nios2-bsp-generate-files --settings=$(BSP_ROOT_DIR)/settings.bsp --bsp-dir=$(BSP_ROOT_DIR)

# Rule to regenerate FPGA files and update BSP in one
.PHONY: fpga
fpga: rebuild-fpga rebuild-bsp

Heredoc

# FIX CPU NAME ISSUE
chmod u+rw Makefile
sed -i 's/ --cpu_name=$(CPU_NAME) / --cpu_name=$(QSYS_SUB_CPU) /g' Makefile

if [ -z "$SKIP_MAKE" ]; then
    cmd="make"

    echo "create-this-app: Running \"$cmd\""
    $cmd || {
        echo "make failed"
        exit 1
    }

    echo
    echo "To download and run the application:"
    echo "    1. Make sure the board is connected to the system."
    echo "    2. Run 'make download-bits' to configure the FPGA with the hardware design."
    echo "    3. If you have a stdio device and generated with --debug,"
    echo "       run 'nios2-terminal' in a different shell."
    echo "    4. Run 'make download-elf' from the application directory."
    echo
    echo "    Note: Simply run 'make download-all' to download bits and elf in all."
    echo
    echo "To (re)create the FPGA configuration run 'make fpga'. This runs Qsys and "
    echo "Quartus flow."
    echo
    echo "To debug the application:"
    echo "    Execute this script with argument --debug"
    echo "    Import the project into Nios II IDE."
    echo
    echo "To burn FPGA hardware design and application into the serial flash (EPCS):"
    echo "    Run 'make program-epcs' from the application directory."
    echo
    echo -e ""
fi


exit 0
